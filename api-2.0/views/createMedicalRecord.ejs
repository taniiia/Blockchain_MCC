<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Medical Record</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* … your existing styles … */
  </style>
</head>
<body>
  <div class="card">
    <h1>Create Record</h1>
    <form id="recordForm">
      <label for="patientID">Patient</label>
      <select name="patientID" id="patientID" required>
        <option value="" disabled selected>— select patient —</option>
        <% patients.forEach(p => { %>
          <!-- Removed the extra '%' after p.uuid -->
          <option value="<%= p.uuid %>"><%= p.name %> (<%= p.uuid %>)</option>
        <% }) %>
      </select>

      <label for="doctorID">Doctor</label>
      <select name="doctorID" id="doctorID" required>
        <option value="" disabled selected>— select doctor —</option>
        <% doctors.forEach(d => { %>
          <option value="<%= d.uuid %>"><%= d.name %> (<%= d.uuid %>)</option>
        <% }) %>
      </select>

      <label for="symptoms">Symptoms</label>
      <textarea name="symptoms" id="symptoms" required placeholder="Describe symptoms…"></textarea>

      <label for="diagnosis">Diagnosis</label>
      <textarea name="diagnosis" id="diagnosis" required placeholder="Enter diagnosis…"></textarea>

      <label for="notes">Notes</label>
      <textarea name="notes" id="notes" required placeholder="Additional notes…"></textarea>

      <input type="hidden" name="peers" value='<%= JSON.stringify(peers) %>' />

      <button type="submit">Submit Record</button>
    </form>
    <div id="status"></div>
  </div>

  <script>
    document.getElementById('recordForm').addEventListener('submit', async e => {
      e.preventDefault();
      const f = e.target;
      const body = {
        patientID: f.patientID.value,
        doctorID:  f.doctorID.value,
        symptoms:  f.symptoms.value,
        diagnosis: f.diagnosis.value,
        notes:     f.notes.value,
        peers:     JSON.parse(f.peers.value)
      };
      try {
        const res = await fetch('/createMedicalRecord', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        const statusEl = document.getElementById('status');
        if (json.success) {
          statusEl.className = '';
          statusEl.innerText = 'Record created successfully!';
        } else {
          statusEl.className = 'error';
          statusEl.innerText = json.message || JSON.stringify(json);
        }
      } catch (err) {
        const statusEl = document.getElementById('status');
        statusEl.className = 'error';
        statusEl.innerText = 'Error: ' + err.message;
      }
    });
  </script>
</body>
</html>
